[phases.setup]
nixPkgs = ["nodejs_20", "pnpm"]
aptPkgs = ["curl", "wget"]

[phases.install]
cmds = ["pnpm install --frozen-lockfile"]

[phases.build]
# Create build-time env so Next.js doesn't crash during static analysis
cmds = [
  "echo 'JWT_SECRET=temporary-build-secret-for-nextjs-compilation' > .env.local",
  "echo 'NEXTAUTH_SECRET=temporary-nextauth-secret-for-build' >> .env.local", 
  "echo 'MONGODB_URI=mongodb://mongodb:27017/bizabode_crm' >> .env.local",
  "echo 'NODE_ENV=production' >> .env.local",
  "echo 'PORT=3000' >> .env.local",
  "echo 'HOSTNAME=0.0.0.0' >> .env.local",
  "echo 'NEXTAUTH_URL=https://your-domain.com' >> .env.local",
  "echo 'SESSION_TIMEOUT=86400000' >> .env.local",
  "echo 'BCRYPT_ROUNDS=12' >> .env.local",
  "echo 'MAX_FILE_SIZE=10485760' >> .env.local",
  "echo 'UPLOAD_DIR=/app/uploads' >> .env.local",
  "echo 'ALLOWED_FILE_TYPES=image/jpeg,image/png,image/gif,application/pdf,text/plain' >> .env.local",
  "echo 'CORS_ORIGIN=https://your-domain.com' >> .env.local",
  "echo 'RATE_LIMIT_WINDOW_MS=900000' >> .env.local",
  "echo 'RATE_LIMIT_MAX_REQUESTS=100' >> .env.local",
  "echo 'LOG_LEVEL=info' >> .env.local",
  "echo 'ENABLE_METRICS=true' >> .env.local",
  "echo 'ENABLE_REQUEST_LOGGING=true' >> .env.local",
  "echo 'REDIS_URL=redis://localhost:6379' >> .env.local",
  "echo 'CACHE_TTL=3600' >> .env.local",
  "echo 'API_VERSION=v1' >> .env.local",
  "echo 'API_PREFIX=/api' >> .env.local",
  "echo 'COMPANY_NAME=Bizabode Digital' >> .env.local",
  "echo 'COMPANY_EMAIL=admin@bizabode.com' >> .env.local",
  "echo 'COMPANY_PHONE=+1-555-0123' >> .env.local",
  "echo 'COMPANY_ADDRESS=123 Business St, City, State 12345' >> .env.local",
  "echo 'ENABLE_EMPLOYEE_MODULE=true' >> .env.local",
  "echo 'ENABLE_INVENTORY_MODULE=true' >> .env.local",
  "echo 'ENABLE_CRM_MODULE=true' >> .env.local",
  "echo 'ENABLE_ACCOUNTING_MODULE=true' >> .env.local",
  "echo 'ENABLE_REPORTING_MODULE=true' >> .env.local",
  "echo 'ENABLE_NOTIFICATIONS=true' >> .env.local",
  "echo 'LICENSE_KEY=DEMO-LICENSE-KEY-2024' >> .env.local",
  "echo 'LICENSE_TYPE=demo' >> .env.local",
  "echo 'LICENSE_EXPIRES=2025-12-31' >> .env.local",
  "echo 'BACKUP_ENABLED=true' >> .env.local",
  "echo 'BACKUP_SCHEDULE=0 2 * * *' >> .env.local",
  "echo 'BACKUP_RETENTION_DAYS=30' >> .env.local",
  "echo 'SSL_ENABLED=true' >> .env.local",
  "echo 'SSL_CERT_PATH=/etc/nginx/ssl/cert.pem' >> .env.local",
  "echo 'SSL_KEY_PATH=/etc/nginx/ssl/key.pem' >> .env.local",
  "echo 'DEBUG_MODE=false' >> .env.local",
  "echo 'ENABLE_DEBUG_ROUTES=false' >> .env.local",
  "echo 'MOCK_PAYMENTS=false' >> .env.local",
  "echo 'MAX_CONNECTIONS=100' >> .env.local",
  "echo 'CONNECTION_TIMEOUT=30000' >> .env.local",
  "echo 'REQUEST_TIMEOUT=30000' >> .env.local",
  "echo 'DB_POOL_SIZE=10' >> .env.local",
  "echo 'DB_POOL_MIN=2' >> .env.local",
  "echo 'DB_POOL_MAX=20' >> .env.local",
  "echo 'ERROR_REPORTING=true' >> .env.local",
  "echo 'ERROR_EMAIL=errors@bizabode.com' >> .env.local",
  "echo 'MAINTENANCE_MODE=false' >> .env.local",
  "echo 'MAINTENANCE_MESSAGE=System is under maintenance. Please try again later.' >> .env.local",
  "echo 'TZ=UTC' >> .env.local",
  "echo 'NODE_OPTIONS=--max-old-space-size=2048' >> .env.local",
  "echo 'DOCKER_NETWORK=bizabode_network' >> .env.local",
  "echo 'DOCKER_VOLUME_PREFIX=bizabode' >> .env.local",
  "echo 'HEALTH_CHECK_INTERVAL=30000' >> .env.local",
  "echo 'HEALTH_CHECK_TIMEOUT=5000' >> .env.local",
  "echo 'RATE_LIMIT_ENABLED=true' >> .env.local",
  "echo 'RATE_LIMIT_SKIP_SUCCESSFUL_REQUESTS=false' >> .env.local",
  "echo 'RATE_LIMIT_SKIP_FAILED_REQUESTS=false' >> .env.local",
  "echo 'CSP_ENABLED=true' >> .env.local",
  "echo 'CSP_REPORT_URI=/api/csp-report' >> .env.local",
  "echo 'HSTS_MAX_AGE=31536000' >> .env.local",
  "echo 'HSTS_INCLUDE_SUBDOMAINS=true' >> .env.local",
  "echo 'HSTS_PRELOAD=true' >> .env.local",
  "pnpm run build"
]

[start]
cmd = "pnpm run start"

[variables]
NODE_ENV = "production"
PORT = "3000"